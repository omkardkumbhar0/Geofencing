<!DOCTYPE html>
<html>
<head>
  <title>Smart Geofence Demo</title>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <style>
    #map { height: 100vh; width: 75%; float: left; }
    #sidebar {
      width: 25%;
      height: 100vh;
      float: right;
      overflow-y: auto;
      padding: 10px;
      box-sizing: border-box;
      background: #f8f9fa;
      border-left: 2px solid #ddd;
    }
    .fence-item {
      padding: 8px;
      margin: 5px 0;
      border: 1px solid #ccc;
      border-radius: 6px;
      background: #fff;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .fence-item button {
      background: #dc3545;
      border: none;
      color: #fff;
      padding: 4px 8px;
      border-radius: 4px;
      cursor: pointer;
    }
    .fence-item button:hover {
      background: #a71d2a;
    }
  </style>
</head>
<body>
  <div id="map"></div>
  <div id="sidebar">
    <h3>Geofences</h3>
    <div id="fenceList"></div>
  </div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    // Map setup
    var map = L.map('map').setView([16.677, 74.208], 14);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap'
    }).addTo(map);

    var fences = [];
    var insideFences = new Set(); // Track which fences you're inside

    function addFence(lat, lng, radius = 200) {
      var circle = L.circle([lat, lng], { radius, color: 'red' }).addTo(map);
      var id = Date.now();
      fences.push({ id, circle, lat, lng, radius });

      // Add to sidebar
      var div = document.createElement("div");
      div.className = "fence-item";
      div.id = "fence-" + id;
      div.innerHTML = `
        <span>Lat: ${lat.toFixed(4)}, Lng: ${lng.toFixed(4)}</span>
        <button onclick="removeFence(${id})">Remove</button>
      `;
      document.getElementById("fenceList").appendChild(div);
    }

    function removeFence(id) {
      var fence = fences.find(f => f.id === id);
      if (fence) {
        map.removeLayer(fence.circle);
        fences = fences.filter(f => f.id !== id);
        document.getElementById("fence-" + id).remove();
        insideFences.delete(id); // Reset if removed
      }
    }

    // On map click â†’ ask approval before adding
    map.on("click", function(e) {
      if (confirm("Add geofence here?")) {
        addFence(e.latlng.lat, e.latlng.lng);
      }
    });

    // Track user location
    var userMarker = null;
    function updateLocation(lat, lng) {
      if (!userMarker) {
        userMarker = L.marker([lat, lng]).addTo(map).bindPopup("You are here");
      } else {
        userMarker.setLatLng([lat, lng]);
      }

      // Check fences
      fences.forEach(fence => {
        var dist = map.distance([lat, lng], [fence.lat, fence.lng]);
        if (dist <= fence.radius) {
          if (!insideFences.has(fence.id)) {
            insideFences.add(fence.id);
            notify("Entered geofence at (" + fence.lat.toFixed(4) + ", " + fence.lng.toFixed(4) + ")");
          }
        } else {
          if (insideFences.has(fence.id)) {
            insideFences.delete(fence.id);
            notify("Exited geofence at (" + fence.lat.toFixed(4) + ", " + fence.lng.toFixed(4) + ")");
          }
        }
      });
    }

    // Notification logic
    function notify(msg) {
      if (Notification.permission === "granted") {
        new Notification(msg);
      } else {
        alert(msg);
      }
    }

    if (Notification.permission !== "granted") {
      Notification.requestPermission();
    }

    // Auto update location
    if (navigator.geolocation) {
      navigator.geolocation.watchPosition(
        pos => updateLocation(pos.coords.latitude, pos.coords.longitude),
        err => console.log(err),
        { enableHighAccuracy: true }
      );
    } else {
      alert("Geolocation not supported.");
    }
  </script>
</body>
</html>
